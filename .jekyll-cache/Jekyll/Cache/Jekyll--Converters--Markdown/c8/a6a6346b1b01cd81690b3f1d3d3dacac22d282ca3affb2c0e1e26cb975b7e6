I"9<p>ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚ŠGKE (Google Kubernetes Engine)ã§Kubernetesã‚¯ãƒ©ã‚¹ã‚¿ã‚’ä½œæˆã—ã¦ã€ãã®ä¸Šã§Prometheusã¨Grafanaã‚’å‹•ã‹ã—ã¦ã¿ã¾ã™ã€‚</p>

<p>å‰å›ã‚¯ãƒ©ã‚¹ã‚¿ã¨ãã“ã«Ingressã‚’è¿½åŠ ã—ãŸã®ã§ã€ä»Šå›ã¯Ingressã§SSLã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚</p>

<h1 id="ã¯ã˜ã‚ã«">ã¯ã˜ã‚ã«</h1>

<p><a href="https://github.com/jetstack/cert-manager">cert-manager</a>ã‚’ä½¿ã£ã¦Letâ€™s Encryptã‹ã‚‰è¨¼æ˜æ›¸ã‚’å–å¾—ãƒ»è¨­å®šã—ã¦ã„ãã¾ã™ã€‚</p>

<p>cert-managerã§è¨¼æ˜æ›¸ã‚’å–å¾—ã™ã‚‹ãŸã‚ã«ã¯DNSèªè¨¼ã‹HTTPèªè¨¼ã®ã„ãšã‚Œã‹ã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>

<p>DNSèªè¨¼ã¯Route53ã§ã¯ã†ã¾ãå‹•ã‹ãªã‹ã£ãŸã®ã§ã€HTTPèªè¨¼ã§è¡Œã„ã¾ã™ã€‚</p>

<h1 id="cert-managerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«">cert-managerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</h1>

<p>helmã‚’ä½¿ã£ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚</p>

<p>ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>git clone https://github.com/jetstack/cert-manager
<span class="nb">cd </span>cert-manager
helm <span class="nb">install</span> <span class="se">\</span>
    <span class="nt">--name</span> cert-manager <span class="se">\</span>
    <span class="nt">--namespace</span><span class="o">=</span>kube-system <span class="se">\</span>
    contrib/charts/cert-manager <span class="se">\</span>
    <span class="nt">--set</span> ingressShim.extraArgs<span class="o">=</span><span class="s1">'{--default-issuer-name=letsencrypt-prod,--default-issuer-kind=ClusterIssuer}'</span>
</code></pre></div></div>

<h1 id="è¨­å®š">è¨­å®š</h1>

<p>ä¸‹è¨˜yamlã‚’ClusterIssuer.ymlã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>

<p>â€»ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è‡ªåˆ†ã®ã‚‚ã®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">certmanager.k8s.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">acme</span><span class="pi">:</span>
    <span class="c1"># The ACME server URL</span>
    <span class="na">server</span><span class="pi">:</span> <span class="s">https://acme-v01.api.letsencrypt.org/directory</span>
    <span class="c1"># Email address used for ACME registration</span>
    <span class="na">email</span><span class="pi">:</span> <span class="s">(ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹)</span>
    <span class="c1"># Name of a secret used to store the ACME account private key</span>
    <span class="na">privateKeySecretRef</span><span class="pi">:</span>
      <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
    <span class="c1"># Enable the HTTP-01 challenge provider</span>
    <span class="na">http01</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<p>ä¸‹è¨˜yamlã‚’certificate.ymlã¨ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</p>

<p>å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯è‡ªåˆ†ã®ã‚‚ã®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</p>

<p>commonNameã¯è¨¼æ˜æ›¸ã®é€šç§°ã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹ã‚‚ã®ãªã®ã§ã€(ãƒ‰ãƒ¡ã‚¤ãƒ³1)ã‚’æŒ‡å®šã™ã‚‹ã¨ã„ã„ã¨æ€ã„ã¾ã™ã€‚</p>

<p>dnsNamesã§æŒ‡å®šã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã¯<a href="https://jp.globalsign.com/support/faq/516.html">SAN (Subject Alternative Name)</a>ã¨ã—ã¦ç™»éŒ²ã•ã‚Œã¾ã™ã€‚</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">certmanager.k8s.io/v1alpha1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Certificate</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">(ãƒã‚¤ãƒ•ãƒ³ã¤ãªãŒã‚Šã®ãƒ‰ãƒ¡ã‚¤ãƒ³ex</span><span class="pi">:</span> <span class="s">kter-jp)-tls</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">default</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">secretName</span><span class="pi">:</span> <span class="s">(ãƒã‚¤ãƒ•ãƒ³ã¤ãªãŒã‚Šã®ãƒ‰ãƒ¡ã‚¤ãƒ³)-tls</span>
  <span class="na">issuerRef</span><span class="pi">:</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">letsencrypt-prod</span>
    <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterIssuer</span>
  <span class="na">commonName</span><span class="pi">:</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³ex</span><span class="pi">:</span> <span class="s">kter.jp)</span>
  <span class="na">dnsNames</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³1)</span>
  <span class="pi">-</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³2)</span>
  <span class="pi">-</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³3)</span>
  <span class="na">acme</span><span class="pi">:</span>
    <span class="na">config</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">http01</span><span class="pi">:</span>
        <span class="na">ingressClass</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">domains</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³1)</span>
    <span class="pi">-</span> <span class="na">http01</span><span class="pi">:</span>
        <span class="na">ingressClass</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">domains</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³2)</span>
    <span class="pi">-</span> <span class="na">http01</span><span class="pi">:</span>
        <span class="na">ingressClass</span><span class="pi">:</span> <span class="s">nginx</span>
      <span class="na">domains</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">(ãƒ‰ãƒ¡ã‚¤ãƒ³3)</span>
</code></pre></div></div>

<p>è¨­å®šã‚’åæ˜ ã—ã¾ã™ã€‚</p>

<p>ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> ClusterIssuer.yml
kubectl apply <span class="nt">-f</span> certificate.yml
</code></pre></div></div>

<p>é€²æ—ã¯ä¸‹è¨˜ã‚³ãƒãƒ³ãƒ‰ã§ç¢ºèªå‡ºæ¥ã¾ã™ã€‚</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
kubectl describe certificate
</code></pre></div></div>

<h1 id="ç¢ºèª">ç¢ºèª</h1>

<p>å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã«httpsã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€è¨¼æ˜æ›¸ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚</p>

:ET